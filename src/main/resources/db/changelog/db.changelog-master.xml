<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <property relativeToChangelogFile="true"/>

    <!-- Create team first so users can reference teams when we add the FK later -->
    <changeSet id="1764238799812-1" author="rdev (generated)">
        <createTable tableName="team">
            <column name="team_id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="team_name" type="VARCHAR(255)"/>
            <column name="leader_id" type="INT"/>
        </createTable>

        <loadData file="data/team.csv" relativeToChangelogFile="true" tableName="team">
            <column header="team_id" name="team_id" type="NUMERIC"/>
            <column header="team_name" name="team_name" type="STRING"/>
            <column header="leader_id" name="leader_id" type="NUMERIC"/>
        </loadData>
    </changeSet>

    <changeSet id="1764238321761-1" author="rdev (generated)">
        <createTable tableName="area">
            <column name="area_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="area_name" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(1000)"/>
            <column name="priority" type="VARCHAR(255)"/>
        </createTable>

        <loadData file="data/area.csv" relativeToChangelogFile="true" tableName="area">
            <column header="area_id" name="area_id" type="NUMERIC"/>
            <column header="area_name" name="area_name" type="STRING"/>
            <column header="description" name="description" type="STRING"/>
            <column header="priority" name="Priority" type="STRING"/>
        </loadData>
    </changeSet>

    <changeSet id="create-users-table" author="rdev (generated)">
        <createTable tableName="users">
            <column name="user_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(255)"/>
            <column name="second_name" type="VARCHAR(255)"/>
            <column name="username" type="VARCHAR(100)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(100)"/>
            <column name="team_id" type="INT"/>
        </createTable>

        <loadData file="data/user.csv" relativeToChangelogFile="true" tableName="users">
            <column header="user_id" name="user_id" type="NUMERIC"/>
            <column header="first_name" name="first_name" type="STRING"/>
            <column header="second_name" name="second_name" type="STRING"/>
            <column header="username" name="username" type="STRING"/>
            <column header="email" name="email" type="STRING"/>
            <column header="role" name="role" type="STRING"/>
            <column header="team_id" name="team_id" type="NUMERIC"/>
        </loadData>

        <!-- NOTE: foreign key to team is added later in its own changeset after team and users exist -->
    </changeSet>

    <changeSet id="1764238468262-1" author="rdev (generated)">
        <createTable tableName="area_assignments">
            <column name="area_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="assigned_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(255)"/>
        </createTable>

        <!-- composite primary key to ensure uniqueness of the mapping -->
        <addPrimaryKey columnNames="area_id, user_id" constraintName="pk_area_assignments" tableName="area_assignments"/>

        <!-- foreign key to area.area_id -->
        <addForeignKeyConstraint baseTableName="area_assignments" baseColumnNames="area_id"
                                 constraintName="fk_area_assignments_area"
                                 referencedTableName="area" referencedColumnNames="area_id"
                                 onDelete="CASCADE"/>

        <!-- foreign key to users.user_id -->
        <addForeignKeyConstraint baseTableName="area_assignments" baseColumnNames="user_id"
                                 constraintName="fk_area_assignments_user"
                                 referencedTableName="users" referencedColumnNames="user_id"
                                 onDelete="CASCADE"/>

        <loadData file="data/area_assignments.csv" relativeToChangelogFile="true" tableName="area_assignments">
            <column header="area_id" name="area_id" type="NUMERIC"/>
            <column header="user_id" name="user_id" type="NUMERIC"/>
            <column header="assigned_at" name="assigned_at" type="DATE"/>
            <column header="status" name="status" type="STRING"/>
        </loadData>
    </changeSet>

    <!-- add FK from users.team_id to team.team_id AFTER both tables and data exist -->
    <changeSet id="add-fk-user-team" author="rdev (generated)">
        <addForeignKeyConstraint baseTableName="users" baseColumnNames="team_id" constraintName="fk_team_id_user" referencedTableName="team"
                                 referencedColumnNames="team_id" onDelete="SET NULL"/>
    </changeSet>

    <changeSet id="1764672968872-1" author="rdev (generated)">
        <createTable tableName="notification">
            <column name="noti_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="INT"/>
            <column name="title" type="VARCHAR(255)"/>
            <column name="message" type="VARCHAR(1000)"/>
        </createTable>

        <loadData file="data/notification.csv" relativeToChangelogFile="true" tableName="notification">
            <column header="noti_id" name="noti_id" type="NUMERIC"/>
            <column header="user_id" name="user_id" type="NUMERIC"/>
            <column header="title" name="title" type="STRING"/>
            <column header="message" name="message" type="STRING"/>
        </loadData>

        <addForeignKeyConstraint baseTableName="notification" baseColumnNames="user_id"
                                 constraintName="fk_notification_user"
                                 referencedTableName="users" referencedColumnNames="user_id"
                                 onDelete="CASCADE"/>
    </changeSet>

    <!-- Create sightings table -->
    <changeSet id="create-sightings-table" author="rdev (generated)">
        <createTable tableName="sightings">
            <column name="sighting_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="reporter_user_id" type="INT"/>
            <column name="sighting_date" type="DATE"/>
            <column name="duration_minutes" type="INT"/>
            <column name="location" type="VARCHAR(500)"/>
            <column name="latitude" type="DECIMAL(10,7)"/>
            <column name="longitude" type="DECIMAL(10,7)"/>
            <column name="shape" type="VARCHAR(100)"/>
            <column name="description" type="TEXT"/>
            <column name="area_id" type="INT"/>
            <column name="legit_votes" type="INT" defaultValue="0"/>
            <column name="uncertain_votes" type="INT" defaultValue="0"/>
            <column name="hoax_votes" type="INT" defaultValue="0"/>
        </createTable>

        <!-- foreign key to users.user_id for reporter -->
        <addForeignKeyConstraint baseTableName="sightings" baseColumnNames="reporter_user_id"
                                 constraintName="fk_sightings_reporter"
                                 referencedTableName="users" referencedColumnNames="user_id"
                                 onDelete="SET NULL"/>

        <loadData file="data/sightings.csv" relativeToChangelogFile="true" tableName="sightings">
            <column header="sighting_id" name="sighting_id" type="NUMERIC"/>
            <column header="title" name="title" type="STRING"/>
            <column header="reporter_user_id" name="reporter_user_id" type="NUMERIC"/>
            <column header="sighting_date" name="sighting_date" type="DATE"/>
            <column header="duration_minutes" name="duration_minutes" type="NUMERIC"/>
            <column header="location" name="location" type="STRING"/>
            <column header="latitude" name="latitude" type="NUMERIC"/>
            <column header="longitude" name="longitude" type="NUMERIC"/>
            <column header="shape" name="shape" type="STRING"/>
            <column header="description" name="description" type="STRING"/>
            <column header="legit_votes" name="legit_votes" type="NUMERIC"/>
            <column header="uncertain_votes" name="uncertain_votes" type="NUMERIC"/>
            <column header="hoax_votes" name="hoax_votes" type="NUMERIC"/>
            <column header="area_id" name="area_id" type="NUMERIC"/>
        </loadData>
    </changeSet>

    <!-- Create comments table -->
    <changeSet id="create-comments-table" author="rdev (generated)">
        <createTable tableName="comments">
            <column name="comment_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sighting_id" type="INT"/>
            <column name="commenter_user_id" type="INT"/>
            <column name="comment_text" type="TEXT"/>
            <column name="comment_date" type="TIMESTAMP"/>
            <column name="is_anonymous" type="BOOLEAN" defaultValue="false"/>
        </createTable>

        <!-- foreign key to sightings.sighting_id -->
        <addForeignKeyConstraint baseTableName="comments" baseColumnNames="sighting_id"
                                 constraintName="fk_comments_sighting"
                                 referencedTableName="sightings" referencedColumnNames="sighting_id"
                                 onDelete="CASCADE"/>

        <!-- foreign key to users.user_id for commenter -->
        <addForeignKeyConstraint baseTableName="comments" baseColumnNames="commenter_user_id"
                                 constraintName="fk_comments_user"
                                 referencedTableName="users" referencedColumnNames="user_id"
                                 onDelete="SET NULL"/>

        <loadData file="data/comments.csv" relativeToChangelogFile="true" tableName="comments">
            <column header="comment_id" name="comment_id" type="NUMERIC"/>
            <column header="sighting_id" name="sighting_id" type="NUMERIC"/>
            <column header="commenter_user_id" name="commenter_user_id" type="NUMERIC"/>
            <column header="comment_text" name="comment_text" type="STRING"/>
            <column header="comment_date" name="comment_date" type="TIMESTAMP"/>
            <column header="is_anonymous" name="is_anonymous" type="BOOLEAN"/>
        </loadData>
    </changeSet>

    <!-- Add auto-increment to comment_id -->
    <changeSet id="add-autoincrement-comment-id" author="rdev (generated)">
        <addAutoIncrement tableName="comments" columnName="comment_id" columnDataType="INT"/>
    </changeSet>

    <!-- Ensure identity/auto-increment starts after existing data to avoid PK collisions (H2 specific)
         This sets the next value to 1000 so inserts won't conflict with loaded CSV IDs. -->
    <changeSet id="restart-comment-id-identity" author="rdev (generated)">
        <preConditions onFail="MARK_RAN">
            <dbms type="h2"/>
        </preConditions>
        <sql>ALTER TABLE comments ALTER COLUMN comment_id RESTART WITH 1000;</sql>
    </changeSet>

  <changeSet id="add-autoincrement-sighting-id" author="rdev (generated)">
        <addAutoIncrement tableName="sightings" columnName="sighting_id" columnDataType="INT"/>
    </changeSet>

    <changeSet id="set-sightings-identity-seed" author="rdev (generated)">
        <preConditions onFail="MARK_RAN">
            <dbms type="h2" />
        </preConditions>
        <!-- Set the restart value to 1000 (safe value above existing test data) -->
        <sql>ALTER TABLE sightings ALTER COLUMN sighting_id RESTART WITH 1000;</sql>
    </changeSet>

    <changeSet id="add-fk-sightings-area" author="rdev">
        <addForeignKeyConstraint baseTableName="sightings" baseColumnNames="area_id"
                                 constraintName="fk_sightings_area"
                                 referencedTableName="area" referencedColumnNames="area_id"
                                 onDelete="SET NULL"/>
    </changeSet>

</databaseChangeLog>