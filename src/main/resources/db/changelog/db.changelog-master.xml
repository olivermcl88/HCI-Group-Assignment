<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <property relativeToChangelogFile="true"/>

    <!-- Create team first so users can reference teams when we add the FK later -->
    <changeSet id="1764238799812-1" author="rdev (generated)">
        <createTable tableName="team">
            <column name="team_id" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="team_name" type="VARCHAR(255)"/>
            <column name="leader_id" type="INT"/>
        </createTable>

        <loadData file="data/team.csv" relativeToChangelogFile="true" tableName="team">
            <column header="team_id" name="team_id" type="NUMERIC"/>
            <column header="team_name" name="team_name" type="STRING"/>
            <column header="leader_id" name="leader_id" type="NUMERIC"/>
        </loadData>
    </changeSet>

    <changeSet id="1764238321761-1" author="rdev (generated)">
        <createTable tableName="area">
            <column name="area_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="area_name" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(1000)"/>
            <column name="priority" type="VARCHAR(255)"/>
        </createTable>

        <loadData file="data/area.csv" relativeToChangelogFile="true" tableName="area">
            <column header="area_id" name="area_id" type="NUMERIC"/>
            <column header="area_name" name="area_name" type="STRING"/>
            <column header="description" name="description" type="STRING"/>
            <column header="priority" name="Priority" type="STRING"/>
        </loadData>
    </changeSet>

    <changeSet id="create-users-table" author="rdev (generated)">
        <createTable tableName="users">
            <column name="user_id" type="INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(255)"/>
            <column name="second_name" type="VARCHAR(255)"/>
            <column name="username" type="VARCHAR(100)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(100)"/>
            <column name="team_id" type="INT"/>
        </createTable>

        <loadData file="data/user.csv" relativeToChangelogFile="true" tableName="users">
            <column header="user_id" name="user_id" type="NUMERIC"/>
            <column header="first_name" name="first_name" type="STRING"/>
            <column header="second_name" name="second_name" type="STRING"/>
            <column header="username" name="username" type="STRING"/>
            <column header="email" name="email" type="STRING"/>
            <column header="role" name="role" type="STRING"/>
            <column header="team_id" name="team_id" type="NUMERIC"/>
        </loadData>

        <!-- NOTE: foreign key to team is added later in its own changeset after team and users exist -->
    </changeSet>

    <changeSet id="1764238468262-1" author="rdev (generated)">
        <createTable tableName="area_assignments">
            <column name="area_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="assigned_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(255)"/>
        </createTable>

        <!-- composite primary key to ensure uniqueness of the mapping -->
        <addPrimaryKey columnNames="area_id, user_id" constraintName="pk_area_assignments" tableName="area_assignments"/>

        <!-- foreign key to area.area_id -->
        <addForeignKeyConstraint baseTableName="area_assignments" baseColumnNames="area_id"
                                 constraintName="fk_area_assignments_area"
                                 referencedTableName="area" referencedColumnNames="area_id"
                                 onDelete="CASCADE"/>

        <!-- foreign key to users.user_id -->
        <addForeignKeyConstraint baseTableName="area_assignments" baseColumnNames="user_id"
                                 constraintName="fk_area_assignments_user"
                                 referencedTableName="users" referencedColumnNames="user_id"
                                 onDelete="CASCADE"/>

        <loadData file="data/area_assignments.csv" relativeToChangelogFile="true" tableName="area_assignments">
            <column header="area_id" name="area_id" type="NUMERIC"/>
            <column header="user_id" name="user_id" type="NUMERIC"/>
            <column header="assigned_at" name="assigned_at" type="DATE"/>
            <column header="status" name="status" type="STRING"/>
        </loadData>
    </changeSet>

    <!-- add FK from users.team_id to team.team_id AFTER both tables and data exist -->
    <changeSet id="add-fk-user-team" author="rdev (generated)">
        <addForeignKeyConstraint baseTableName="users" baseColumnNames="team_id" constraintName="fk_team_id_user" referencedTableName="team"
                                 referencedColumnNames="team_id" onDelete="SET NULL"/>
    </changeSet>

</databaseChangeLog>