<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sighting Details</title>
    
    <link rel="stylesheet" href="/ufo-app/css/sightings.css" />
    <link rel="stylesheet" href="/ufo-app/css/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div th:insert="navbar :: navbar">  </div>

        <!-- Navigation for different sightings -->
        <div th:if="${sightings != null and !sightings.isEmpty()}" class="sightings-nav">
            <div class="sightings-nav-header">
                <h3>All Sightings:</h3>
                <a th:href="@{/sightings/new}" class="btn add-btn" style="color:white">+ Report Sighting</a>
            </div>
            <ul>
                <li th:each="sighting : ${sightings}">
                    <a th:href="@{/sightings/{id}(id=${sighting.sightingId})}"
                       th:class="${currentSighting != null and currentSighting.sightingId == sighting.sightingId} ? 'active' : ''">
                        <span th:text="${sighting.title}">Sighting Title</span>
                        <small th:class="${currentSighting != null and currentSighting.sightingId == sighting.sightingId} ? 'active' : ''" th:text="${areasMap != null && sighting.areaId != null ? areasMap[sighting.areaId] : ''}"></small>
                    </a>
                </li>
            </ul>
        </div>

        <div th:if="${currentSighting != null}">
            <h1 class="header-title" th:text="${currentSighting.title}">Sightings Title</h1>

            <div class="profile">
                <div class="profile-circle" th:text="${reporter != null ? reporter.firstName?.substring(0,1) : 'U'}">P</div>
                <div>
                    <div><strong th:text="${reporter != null ? reporter.username : 'Unknown User'}">Username</strong></div>
                    <div style="color: grey; font-size: 14px;">Reporter</div>
                </div>
            </div>

            <div class="meta">
                <div class="meta-item">üìÖ <span th:text="${#temporals.format(currentSighting.sightingDate, 'dd/MM/yyyy')}">01/01/25</span></div>
                <div class="meta-item">üìå <span th:text="${currentSightingAreaName != null ? currentSightingAreaName : (areasMap != null && currentSighting.areaId != null ? areasMap[currentSighting.areaId] : '')}">Area Name</span></div>
                <div class="meta-item">‚è±Ô∏è <span th:text="${currentSighting.durationMinutes}">12</span> minutes</div>
                <div class="meta-item">üìç <span th:text="${currentSighting.location}">Location</span><br/>
                    <span th:text="${currentSighting.latitude + ', ' + currentSighting.longitude}">Coordinates</span>
                </div>
                <div class="meta-item">üî∫ <span th:text="${currentSighting.shape}">Shape</span></div>
            </div>

            <div id="map" class="map-box" th:data-lat="${currentSighting.latitude}" th:data-lng="${currentSighting.longitude}" th:data-location="${currentSighting.location}">
                <div class="map-loading">Loading interactive map...</div>
            </div>

            <h3>Description</h3>
            <textarea readonly th:text="${currentSighting.description}">Lorem ipsum dolor sit amet, consectetur adipiscing elit...</textarea>

            <div class="evidence-buttons">
                <a th:href="@{/sightings/{id}/evidence(id=${currentSighting.sightingId})}" class="btn">üìÑ View Evidence</a>
                <form th:action="@{/sightings/{id}/upload-evidence(id=${currentSighting.sightingId})}" method="post" enctype="multipart/form-data" class="evidence-upload-form" style="display: inline;">
                    <input type="file" name="evidence" accept="image/*,video/*,.pdf,.doc,.docx" id="evidenceFile" style="display: none;" />
                    <input type="hidden" name="userId" value="1" />
                    <button type="button" class="btn evidence-btn" onclick="document.getElementById('evidenceFile').click()">üìÅ Upload Evidence</button>
                </form>
            </div>

            <h2>Community Validation</h2>
            <div>
                Legitimate: <span th:text="${legitPercentage}">35</span>% (<span th:text="${legitVotes}">5</span> votes) &nbsp;&nbsp; 
                Uncertain: <span th:text="${uncertainPercentage}">55</span>% (<span th:text="${uncertainVotes}">8</span> votes) &nbsp;&nbsp; 
                Hoax: <span th:text="${hoaxPercentage}">10</span>% (<span th:text="${hoaxVotes}">2</span> votes)
            </div>
            <div th:if="${totalVotes > 0}" style="margin-top: 5px; color: #666; font-size: 14px;">
                Total votes: <span th:text="${totalVotes}">15</span>
            </div>
            <div th:if="${userVote != null}" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-weight: bold;">
                Your vote: <span th:text="${userVote.voteType}">LEGIT</span> 
                <span style="font-weight: normal; color: #666;">(click a button below to change your vote)</span>
            </div>

            <div class="validation-bar">
                <div class="legit" th:style="'width: ' + ${legitPercentage} + '%'"></div>
                <div class="uncertain" th:style="'width: ' + ${uncertainPercentage} + '%'"></div>
                <div class="hoax" th:style="'width: ' + ${hoaxPercentage} + '%'"></div>
            </div>

            <form th:action="@{/sightings/{id}/vote(id=${currentSighting.sightingId})}" method="post" class="validation-buttons">
                <input type="hidden" name="userId" th:value="${currentUserId}" />
                <button type="submit" name="voteType" value="legit" 
                        th:class="'vote-btn vote-legit' + ${userVote != null && userVote.voteType.name() == 'LEGIT' ? ' current-vote' : ''}">Legitimate</button>
                <button type="submit" name="voteType" value="uncertain" 
                        th:class="'vote-btn vote-uncertain' + ${userVote != null && userVote.voteType.name() == 'UNCERTAIN' ? ' current-vote' : ''}">Uncertain</button>
                <button type="submit" name="voteType" value="hoax" 
                        th:class="'vote-btn vote-hoax' + ${userVote != null && userVote.voteType.name() == 'HOAX' ? ' current-vote' : ''}">Hoax</button>
            </form>

            <h2>Comments</h2>
            
            <form th:action="@{/sightings/{id}/comment(id=${currentSighting.sightingId})}" method="post" class="comment-form" enctype="multipart/form-data">
                <div class="comment-input-section">
                    <textarea name="commentText" placeholder="Share your thoughts about this sighting..." required></textarea>
                    <div class="comment-options">
                        <div class="comment-file-upload">
                            <input type="file" name="attachment" id="commentAttachment" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;" />
                            <label for="commentAttachment" class="btn file-upload-btn">üìé Attach File</label>
                            <span id="selectedFileName" class="selected-file-name"></span>
                        </div>
                        <label>
                            <input type="checkbox" name="isAnonymous" value="true" />
                            Post anonymously
                        </label>
                        <input type="hidden" name="userId" value="1" /> <!-- For demo purposes, using user ID 1 -->
                        <button type="submit" class="btn comment-btn">Post Comment</button>
                    </div>
                </div>
            </form>

            <div class="comments-list">
                <div th:if="${comments != null and !comments.isEmpty()}">
                    <!-- Group comments by thread -->
                    <div th:each="comment : ${comments}" th:if="${comment.parentCommentId == null}" class="comment-thread">
                        <!-- Main comment -->
                        <div class="comment-item" th:classappend="'level-' + ${comment.replyLevel}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <span th:if="${!comment.isAnonymous and comment.commenterUsername != null}">
                                        <strong th:text="${comment.commenterUsername}">Username</strong>
                                    </span>
                                    <span th:if="${comment.isAnonymous or comment.commenterUsername == null}">
                                        <strong>Anonymous</strong>
                                    </span>
                                </div>
                                <div class="comment-date" th:text="${#temporals.format(comment.commentDate, 'dd/MM/yyyy HH:mm')}">Date</div>
                            </div>
                            <div class="comment-text" th:text="${comment.commentText}">Comment text</div>
                            <div th:if="${comment.attachmentFilename != null}" class="comment-attachment">
                                <a th:href="@{/comment-attachment/{filename}(filename=${comment.attachmentFilename})}" 
                                   th:text="'üìé ' + ${comment.attachmentOriginalName != null ? comment.attachmentOriginalName : 'Attachment'}" 
                                   class="attachment-link" target="_blank">
                                    üìé Attachment
                                </a>
                            </div>
                            <div class="comment-actions">
                                <button class="reply-btn" th:onclick="'toggleReplyForm(' + ${comment.commentId} + ')'">üí¨ Reply</button>
                            </div>
                            
                            <!-- Reply form (initially hidden) -->
                            <div th:id="'reply-form-' + ${comment.commentId}" class="reply-form" style="display: none;">
                                <form th:action="@{/sightings/{id}/comment(id=${currentSighting.sightingId})}" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="parentCommentId" th:value="${comment.commentId}" />
                                    <div class="reply-input-section">
                                        <textarea name="commentText" th:placeholder="'Reply to ' + ${comment.commenterUsername != null ? comment.commenterUsername : 'Anonymous'} + '...'" required></textarea>
                                        <div class="reply-options">
                                            <div class="comment-file-upload">
                                                <input type="file" name="attachment" th:id="'replyAttachment' + ${comment.commentId}" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;" />
                                                <label th:for="'replyAttachment' + ${comment.commentId}" class="btn file-upload-btn">üìé Attach File</label>
                                                <span th:id="'selectedReplyFileName' + ${comment.commentId}" class="selected-file-name"></span>
                                            </div>
                                            <label>
                                                <input type="checkbox" name="isAnonymous" value="true" />
                                                Post anonymously
                                            </label>
                                            <input type="hidden" name="userId" value="1" />
                                            <div class="reply-buttons">
                                                <button type="submit" class="btn comment-btn">Post Reply</button>
                                                <button type="button" class="btn cancel-btn" th:onclick="'toggleReplyForm(' + ${comment.commentId} + ')'">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Replies -->
                        <div class="replies-container">
                            <div th:each="reply : ${comments}" th:if="${reply.parentCommentId != null and reply.parentCommentId == comment.commentId}" 
                                 class="comment-item reply" th:classappend="'level-' + ${reply.replyLevel}">
                                <div class="reply-indicator">
                                    <span class="reply-arrow">‚Ü≥</span>
                                    <span class="reply-to" th:if="${reply.parentCommenterUsername != null}">
                                        Replying to <strong th:text="${reply.parentCommenterUsername}">Parent User</strong>
                                    </span>
                                </div>
                                <div class="comment-header">
                                    <div class="comment-author">
                                        <span th:if="${!reply.isAnonymous and reply.commenterUsername != null}">
                                            <strong th:text="${reply.commenterUsername}">Username</strong>
                                        </span>
                                        <span th:if="${reply.isAnonymous or reply.commenterUsername == null}">
                                            <strong>Anonymous</strong>
                                        </span>
                                    </div>
                                    <div class="comment-date" th:text="${#temporals.format(reply.commentDate, 'dd/MM/yyyy HH:mm')}">Date</div>
                                </div>
                                <div class="comment-text" th:text="${reply.commentText}">Reply text</div>
                                <div th:if="${reply.attachmentFilename != null}" class="comment-attachment">
                                    <a th:href="@{/comment-attachment/{filename}(filename=${reply.attachmentFilename})}" 
                                       th:text="'üìé ' + ${reply.attachmentOriginalName != null ? reply.attachmentOriginalName : 'Attachment'}" 
                                       class="attachment-link" target="_blank">
                                        üìé Attachment
                                    </a>
                                </div>
                                <div class="comment-actions" th:if="${reply.replyLevel < 3}">
                                    <button class="reply-btn" th:onclick="'toggleReplyForm(' + ${reply.commentId} + ')'">üí¨ Reply</button>
                                </div>
                                
                                <!-- Reply to reply form -->
                                <div th:id="'reply-form-' + ${reply.commentId}" class="reply-form" style="display: none;">
                                    <form th:action="@{/sightings/{id}/comment(id=${currentSighting.sightingId})}" method="post" enctype="multipart/form-data">
                                        <input type="hidden" name="parentCommentId" th:value="${reply.commentId}" />
                                        <div class="reply-input-section">
                                            <textarea name="commentText" th:placeholder="'Reply to ' + ${reply.commenterUsername != null ? reply.commenterUsername : 'Anonymous'} + '...'" required></textarea>
                                            <div class="reply-options">
                                                <div class="comment-file-upload">
                                                    <input type="file" name="attachment" th:id="'replyAttachment' + ${reply.commentId}" accept="image/*,video/*,.pdf,.doc,.docx,.txt" style="display: none;" />
                                                    <label th:for="'replyAttachment' + ${reply.commentId}" class="btn file-upload-btn">üìé Attach File</label>
                                                    <span th:id="'selectedReplyFileName' + ${reply.commentId}" class="selected-file-name"></span>
                                                </div>
                                                <label>
                                                    <input type="checkbox" name="isAnonymous" value="true" />
                                                    Post anonymously
                                                </label>
                                                <input type="hidden" name="userId" value="1" />
                                                <div class="reply-buttons">
                                                    <button type="submit" class="btn comment-btn">Post Reply</button>
                                                    <button type="button" class="btn cancel-btn" th:onclick="'toggleReplyForm(' + ${reply.commentId} + ')'">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${comments == null or comments.isEmpty()}" class="no-comments">
                    <p>No comments yet. Be the first to share your thoughts!</p>
                </div>
            </div>
        </div>

        <div th:if="${currentSighting == null}">
            <h1>No Sightings Available</h1>
            <p>There are currently no UFO sightings to display.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script th:if="${currentSighting != null}" src="/ufo-app/js/sightings-map.js"></script>
    <script>
        // Handle evidence file upload
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('evidenceFile');
            const uploadForm = document.querySelector('.evidence-upload-form');

            if (fileInput && uploadForm) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        // Show selected file name
                        const fileName = this.files[0].name;
                        const confirmUpload = confirm(`Upload "${fileName}" as evidence?`);

                        if (confirmUpload) {
                            uploadForm.submit();
                        } else {
                            // Clear the file input
                            this.value = '';
                        }
                    }
                });
            }
            
            // Handle comment attachment file selection
            const commentFileInput = document.getElementById('commentAttachment');
            const selectedFileName = document.getElementById('selectedFileName');
            
            if (commentFileInput && selectedFileName) {
                commentFileInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        const fileName = this.files[0].name;
                        selectedFileName.textContent = fileName;
                        selectedFileName.style.display = 'inline';
                    } else {
                        selectedFileName.textContent = '';
                        selectedFileName.style.display = 'none';
                    }
                });
            }
            
            // Handle reply attachment file selections
            document.addEventListener('change', function(e) {
                if (e.target.id && e.target.id.startsWith('replyAttachment')) {
                    const commentId = e.target.id.replace('replyAttachment', '');
                    const selectedFileName = document.getElementById('selectedReplyFileName' + commentId);
                    
                    if (selectedFileName) {
                        if (e.target.files && e.target.files.length > 0) {
                            const fileName = e.target.files[0].name;
                            selectedFileName.textContent = fileName;
                            selectedFileName.style.display = 'inline';
                        } else {
                            selectedFileName.textContent = '';
                            selectedFileName.style.display = 'none';
                        }
                    }
                }
            });
        });
        
        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById('reply-form-' + commentId);
            if (replyForm) {
                if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                    // Hide all other reply forms
                    const allReplyForms = document.querySelectorAll('.reply-form');
                    allReplyForms.forEach(form => form.style.display = 'none');
                    
                    // Show this reply form
                    replyForm.style.display = 'block';
                    
                    // Focus on the textarea
                    const textarea = replyForm.querySelector('textarea');
                    if (textarea) {
                        textarea.focus();
                    }
                } else {
                    replyForm.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>
