<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sighting Details</title>
    
    <link rel="stylesheet" href="/ufo-app/css/sightings.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation for different sightings -->
        <div th:if="${sightings != null and !sightings.isEmpty()}" class="sightings-nav">
            <h3>All Sightings:</h3>
            <ul>
                <li th:each="sighting : ${sightings}">
                    <a th:href="@{/sightings/{id}(id=${sighting.sightingId})}" 
                       th:text="${sighting.title}"
                       th:class="${currentSighting != null and currentSighting.sightingId == sighting.sightingId} ? 'active' : ''">
                       Sighting Title
                    </a>
                </li>
            </ul>
        </div>

        <div th:if="${currentSighting != null}">
            <h1 class="header-title" th:text="${currentSighting.title}">Sightings Title</h1>

            <div class="profile">
                <div class="profile-circle" th:text="${reporter != null ? reporter.firstName?.substring(0,1) : 'U'}">P</div>
                <div>
                    <div><strong th:text="${reporter != null ? reporter.username : 'Unknown User'}">Username</strong></div>
                    <div style="color: gray; font-size: 14px;">Reporter</div>
                </div>
            </div>

            <div class="meta">
                <div class="meta-item">üìÖ <span th:text="${#temporals.format(currentSighting.sightingDate, 'dd/MM/yyyy')}">01/01/25</span></div>
                <div class="meta-item">‚è±Ô∏è <span th:text="${currentSighting.durationMinutes}">12</span> minutes</div>
                <div class="meta-item">üìç <span th:text="${currentSighting.location}">Location</span><br/>
                    <span th:text="${currentSighting.latitude + ', ' + currentSighting.longitude}">Coordinates</span>
                </div>
                <div class="meta-item">üî∫ <span th:text="${currentSighting.shape}">Shape</span></div>
            </div>

            <div id="map" class="map-box" th:data-lat="${currentSighting.latitude}" th:data-lng="${currentSighting.longitude}" th:data-location="${currentSighting.location}">
                <div class="map-loading">Loading interactive map...</div>
            </div>

            <h3>Description/Comments</h3>
            <textarea readonly th:text="${currentSighting.description}">Lorem ipsum dolor sit amet, consectetur adipiscing elit...</textarea>

            <div class="evidence-buttons">
                <button class="btn">üìÑ View Evidence</button>
                <button class="btn">‚¨ÜÔ∏è Upload Evidence</button>
            </div>

            <h2>Community Validation</h2>
            <div>
                Legitimate: <span th:text="${currentSighting.legitPercentage}">35</span>% &nbsp;&nbsp; 
                Uncertain: <span th:text="${currentSighting.uncertainPercentage}">55</span>% &nbsp;&nbsp; 
                Hoax: <span th:text="${currentSighting.hoaxPercentage}">10</span>%
            </div>

            <div class="validation-bar">
                <div class="legit" th:style="'width: ' + ${currentSighting.legitPercentage} + '%'"></div>
                <div class="uncertain" th:style="'width: ' + ${currentSighting.uncertainPercentage} + '%'"></div>
                <div class="hoax" th:style="'width: ' + ${currentSighting.hoaxPercentage} + '%'"></div>
            </div>

            <form th:action="@{/sightings/{id}/vote(id=${currentSighting.sightingId})}" method="post" class="validation-buttons">
                <button type="submit" name="voteType" value="legit" class="vote-btn vote-legit">Legitimate</button>
                <button type="submit" name="voteType" value="uncertain" class="vote-btn vote-uncertain">Uncertain</button>
                <button type="submit" name="voteType" value="hoax" class="vote-btn vote-hoax">Hoax</button>
            </form>
        </div>

        <div th:if="${currentSighting == null}">
            <h1>No Sightings Available</h1>
            <p>There are currently no UFO sightings to display.</p>
        </div>
    </div>

    <script th:if="${currentSighting != null}">
        let currentMap = null; // Global map variable to prevent multiple initializations
        
        function initializeMap() {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }
            
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Map loading... Please refresh if map doesn\'t appear.</div>';
                return;
            }
            
            // If map already exists, remove it first
            if (currentMap) {
                try {
                    currentMap.remove();
                } catch(e) {
                    console.warn('Error removing existing map:', e);
                }
                currentMap = null;
            }
            
            const lat = parseFloat(mapElement.dataset.lat);
            const lng = parseFloat(mapElement.dataset.lng);
            const location = mapElement.dataset.location;
            
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates:', lat, lng);
                mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Invalid location data</div>';
                return;
            }
            
            try {
                // Clear loading message
                const loadingDiv = mapElement.querySelector('.map-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                
                // Create new map instance
                currentMap = L.map('map', {
                    center: [lat, lng],
                    zoom: 13,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(currentMap);
                
                // Custom UFO icon
                const ufoIcon = L.divIcon({
                    html: 'üõ∏',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15],
                    className: 'ufo-marker'
                });
                
                // Add marker for the sighting location
                const marker = L.marker([lat, lng], {icon: ufoIcon}).addTo(currentMap);
                
                // Add popup with sighting information
                marker.bindPopup(`
                    <div style="text-align: center; font-size: 14px;">
                        <strong>üõ∏ UFO Sighting</strong><br/>
                        <em>${location}</em><br/>
                        <small>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}</small>
                    </div>
                `).openPopup();
                
                console.log('Map initialized successfully for coordinates:', lat, lng);
                
                // Force map to resize after initialization
                setTimeout(function() {
                    if (currentMap) {
                        currentMap.invalidateSize();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error initializing map:', error);
                mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Error loading map. Please refresh the page.</div>';
                if (currentMap) {
                    try {
                        currentMap.remove();
                    } catch(e) {
                        // Ignore cleanup errors
                    }
                    currentMap = null;
                }
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMap);
        } else {
            // DOM is already ready
            initializeMap();
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (currentMap) {
                try {
                    currentMap.remove();
                } catch(e) {
                    // Ignore cleanup errors
                }
                currentMap = null;
            }
        });
    </script>
</body>
</html>
